<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Discussion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #000000;
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .header p {
            font-size: 1.1rem;
            color: #ccc;
        }

        .video-section {
            background-color: #111;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .video-wrapper {
            width: 100%;
            background-color: #222;
            border-radius: 8px;
            overflow: hidden;
        }

        .video-wrapper iframe {
            width: 100%;
            height: 400px;
            border: none;
        }

        .video-fallback {
            text-align: center;
            padding: 40px;
            background-color: #222;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .youtube-link {
            display: inline-block;
            background-color: #ffffff;
            color: #000000;
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid #fff;
            margin-right: 15px;
        }

        .youtube-link:hover {
            background-color: #000000;
            color: #ffffff;
            border-color: #fff;
        }

        .retry-btn {
            background-color: #333;
            color: #fff;
            border: 2px solid #666;
            border-radius: 5px;
            padding: 15px 30px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            background-color: #555;
        }

        .comments-section {
            background-color: #111;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 30px;
        }

        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }

        .comments-header h2 {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .comment-count {
            background-color: #333;
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .comment-form {
            background-color: #222;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            background-color: #000;
            border: 2px solid #444;
            border-radius: 5px;
            padding: 12px 15px;
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #666;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #888;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .submit-btn {
            background-color: #fff;
            color: #000;
            border: 2px solid #fff;
            border-radius: 5px;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background-color: #000;
            color: #fff;
        }

        .comments-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .comments-list::-webkit-scrollbar {
            width: 8px;
        }

        .comments-list::-webkit-scrollbar-track {
            background: #222;
        }

        .comments-list::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        .comment {
            background-color: #222;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: background-color 0.3s ease;
        }

        .comment:hover {
            background-color: #2a2a2a;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .comment-author {
            font-weight: bold;
            color: #fff;
            font-size: 1.1rem;
        }

        .comment-time {
            color: #888;
            font-size: 0.9rem;
        }

        .comment-text {
            color: #ccc;
            line-height: 1.6;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .video-section,
            .comments-section {
                padding: 20px;
            }
            
            .comment-form {
                padding: 20px;
            }
            
            .comments-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .youtube-link {
                margin-bottom: 15px;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VIDEO DISCUSSION</h1>
            <p>Watch and join the conversation</p>
        </div>

        <div class="video-section">
            <div class="video-wrapper" id="videoWrapper">
                <iframe id="videoFrame"
                    src="https://www.youtube.com/embed/WF3oSg_jaPU?rel=0&modestbranding=1" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>
            <div class="video-fallback" id="videoFallback" style="display: none;">
                <h3>Video Loading...</h3>
                <p style="margin: 20px 0; color: #ccc;">Embedding permissions are being updated. This may take a few minutes.</p>
                <a href="https://www.youtube.com/watch?v=WF3oSg_jaPU" target="_blank" class="youtube-link">
                    WATCH ON YOUTUBE
                </a>
                <button onclick="retryEmbed()" class="retry-btn">
                    RETRY EMBED
                </button>
            </div>
        </div>

        <div class="comments-section">
            <div class="comments-header">
                <h2>COMMENTS</h2>
                <span class="comment-count" id="commentCount">0 COMMENTS</span>
            </div>

            <div class="comment-form">
                <div class="form-group">
                    <input type="text" id="authorName" placeholder="Your name" maxlength="50">
                </div>
                <div class="form-group">
                    <textarea id="commentText" placeholder="Share your thoughts about the video..." maxlength="500"></textarea>
                </div>
                <button class="submit-btn" onclick="addComment()">POST COMMENT</button>
            </div>

            <div class="comments-list" id="commentsList">
                <div class="empty-state">
                    <h3>No comments yet</h3>
                    <p>Be the first to share your thoughts about this video</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let comments = [];
        const GITHUB_USERNAME = 'kaido-dev';
        const GITHUB_REPO = 'Rapbattles';
        const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/issues`;

        async function loadCommentsFromGitHub() {
            try {
                const response = await fetch(`${GITHUB_API_URL}?labels=comment&state=open&sort=created&direction=desc`);
                if (response.ok) {
                    const issues = await response.json();
                    comments = issues.map(issue => ({
                        id: issue.number,
                        author: issue.title.replace('[COMMENT] ', ''),
                        text: issue.body,
                        timestamp: new Date(issue.created_at)
                    }));
                    updateCommentCount();
                    renderComments();
                } else {
                    console.log('Could not load comments from GitHub');
                }
            } catch (error) {
                console.log('Error loading comments:', error);
            }
        }

        async function postCommentToGitHub(author, text) {
            const issueData = {
                title: `[COMMENT] ${author}`,
                body: text,
                labels: ['comment']
            };

            try {
                const response = await fetch(GITHUB_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(issueData)
                });

                if (response.ok) {
                    const newIssue = await response.json();
                    const newComment = {
                        id: newIssue.number,
                        author: author,
                        text: text,
                        timestamp: new Date(newIssue.created_at)
                    };
                    comments.unshift(newComment);
                    updateCommentCount();
                    renderComments();
                    return true;
                } else {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
            } catch (error) {
                console.error('Error posting comment:', error);
                return false;
            }
        }

        function retryEmbed() {
            const wrapper = document.getElementById('videoWrapper');
            const fallback = document.getElementById('videoFallback');
            const iframe = document.getElementById('videoFrame');
            
            fallback.querySelector('h3').textContent = 'Retrying...';
            iframe.src = iframe.src;
            
            setTimeout(checkEmbedStatus, 3000);
        }

        function checkEmbedStatus() {
            const wrapper = document.getElementById('videoWrapper');
            const fallback = document.getElementById('videoFallback');
            const iframe = document.getElementById('videoFrame');
            
            iframe.onload = function() {
                wrapper.style.display = 'block';
                fallback.style.display = 'none';
            };
            
            iframe.onerror = function() {
                wrapper.style.display = 'none';
                fallback.style.display = 'block';
                fallback.querySelector('h3').textContent = 'Still Processing...';
            };
            
            setTimeout(() => {
                try {
                    if (wrapper.style.display !== 'none') {
                        console.log('Video embed appears to be working');
                    }
                } catch (e) {
                    wrapper.style.display = 'none';
                    fallback.style.display = 'block';
                }
            }, 10000);
        }

        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return 'JUST NOW';
            if (minutes < 60) return `${minutes}M AGO`;
            if (minutes < 1440) return `${Math.floor(minutes / 60)}H AGO`;
            return `${Math.floor(minutes / 1440)}D AGO`;
        }

        function updateCommentCount() {
            const count = comments.length;
            const countElement = document.getElementById('commentCount');
            countElement.textContent = `${count} COMMENT${count !== 1 ? 'S' : ''}`;
        }

        function renderComments() {
            const commentsList = document.getElementById('commentsList');
            
            if (comments.length === 0) {
                commentsList.innerHTML = `
                    <div class="empty-state">
                        <h3>No comments yet</h3>
                        <p>Be the first to share your thoughts about this video</p>
                    </div>
                `;
                return;
            }

            commentsList.innerHTML = comments.map(comment => `
                <div class="comment">
                    <div class="comment-header">
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-time">${formatTime(comment.timestamp)}</span>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                </div>
            `).join('');
        }

        async function addComment() {
            const authorInput = document.getElementById('authorName');
            const textInput = document.getElementById('commentText');
            const submitBtn = document.querySelector('.submit-btn');
            
            const author = authorInput.value.trim();
            const text = textInput.value.trim();
            
            if (!author || !text) {
                alert('Please fill in both your name and comment.');
                return;
            }

            // Disable button and show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'POSTING...';

            const success = await postCommentToGitHub(author, text);
            
            if (success) {
                authorInput.value = '';
                textInput.value = '';
                submitBtn.textContent = 'POSTED!';
                setTimeout(() => {
                    submitBtn.textContent = 'POST COMMENT';
                    submitBtn.disabled = false;
                }, 2000);
            } else {
                alert('Failed to post comment. This might be because the repository needs to be configured for public comments. The comment has been saved locally for now.');
                // Fallback to local storage
                const comment = {
                    id: Date.now(),
                    author: author,
                    text: text,
                    timestamp: new Date()
                };
                comments.unshift(comment);
                updateCommentCount();
                renderComments();
                
                authorInput.value = '';
                textInput.value = '';
                submitBtn.textContent = 'POST COMMENT';
                submitBtn.disabled = false;
            }
        }

        document.getElementById('commentText').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                addComment();
            }
        });

        // Refresh comments every 30 seconds to show new comments from other users
        setInterval(() => {
            loadCommentsFromGitHub();
        }, 30000);

        // Initialize
        updateCommentCount();
        checkEmbedStatus();
        loadCommentsFromGitHub();
    </script>
</body>
</html>
